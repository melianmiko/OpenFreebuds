name: Build & Test
on: push

jobs:
  PyTest:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install Poetry
        uses: abatilo/actions-poetry@v2
        with:
          poetry-version: "1.8.3"
      - uses: actions/checkout@v4
      - name: Set up poetry environment
        run: poetry install --without extras
      - name: Run pytest
        run: poetry run pytest

  BuildExe:
    runs-on: windows-latest
    steps:
      - name: Install Qt Lrelease
        run: |
          (New-Object System.Net.WebClient).DownloadFile("https://st.mmk.pw/lrelease.zip","lrelease.zip");
          Expand-Archive .\lrelease.zip ..\lrelease;
          echo "$((Get-Item ..).FullName)/lrelease" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install Poetry
        uses: abatilo/actions-poetry@v2
        with:
          poetry-version: "1.8.3"
      - name: Install Just
        run: choco install just
      - uses: actions/checkout@v4
      - run: just prepare
      - run: just bump_version_git build pkg_win32_portable
      - name: Upload portable
        uses: actions/upload-artifact@v4
        with:
          name: openfreebuds_win32
          path: .\dist\*
          if-no-files-found: error

  BuildDeb:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install Poetry
        uses: abatilo/actions-poetry@v2
        with:
          poetry-version: "1.8.3"
      - name: Install Just
        run: curl -s https://just.systems/install.sh | sudo bash -s -- --to /usr/local/bin
      - uses: actions/checkout@v4
      - run: just dependencies_debian prepare
      - run: just bump_version_git build pkg_debian
      - name: Upload bundle
        uses: actions/upload-artifact@v4
        with:
          name: openfreebuds_debian
          path: ./dist/*
          if-no-files-found: error
